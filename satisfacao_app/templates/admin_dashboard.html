<!-- templates/admin_dashboard.html -->
<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>Dashboard de Satisfação</h1>

    <section>
        <h2>Totais</h2>
        <p>Muito satisfeito: {{ totals["muito_satisfeito"] }} ({{ "%.1f"|format(percentages["muito_satisfeito"]) }}%)</p>
        <p>Satisfeito: {{ totals["satisfeito"] }} ({{ "%.1f"|format(percentages["satisfeito"]) }}%)</p>
        <p>Insatisfeito: {{ totals["insatisfeito"] }} ({{ "%.1f"|format(percentages["insatisfeito"]) }}%)</p>
    </section>

    <section>
        <h2>Gráfico de barras</h2>
        <canvas id="barChart"></canvas>
    </section>

    <section>
        <h2>Filtros temporais</h2>
        <form id="filter-form">
            <label>Data:</label>
            <input type="date" name="date">
            <button type="submit">Filtrar</button>
        </form>
    </section>

    <section>
        <h2>Tabela de registos</h2>
        <div id="table-container"></div>
    </section>

    <section>
        <h2>Exportação</h2>
        <a href="{{ url_for('export_csv') }}">Exportar CSV</a> |
        <a href="{{ url_for('export_txt') }}">Exportar TXT</a>
    </section>

    <script>
        const totals = {{ totals|tojson }};
        const ctx = document.getElementById('barChart').getContext('2d');
        const barChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Muito satisfeito', 'Satisfeito', 'Insatisfeito'],
                datasets: [{
                    label: 'Nº de respostas',
                    data: [
                        totals.muito_satisfeito,
                        totals.satisfeito,
                        totals.insatisfeito
                    ],
                    backgroundColor: ['#2ecc71', '#3498db', '#e74c3c']
                }]
            }
        );

        // Carregar tabela via API
        function loadTable(date=null) {
            let url = "/api/admin/records";
            if (date) url += "?date=" + encodeURIComponent(date);
            fetch(url)
                .then(r => r.json())
                .then(data => {
                    const container = document.getElementById("table-container");
                    let html = "<table border='1'><tr><th>ID</th><th>Satisfação</th><th>Data</th><th>Hora</th><th>Dia</th></tr>";
                    data.records.forEach(r => {
                        html += `<tr>
                            <td>${r.id}</td>
                            <td>${r.satisfaction}</td>
                            <td>${r.date}</td>
                            <td>${r.time}</td>
                            <td>${r.weekday}</td>
                        </tr>`;
                    });
                    html += "</table>";
                    container.innerHTML = html;
                });
        }

        loadTable();

        document.getElementById("filter-form").addEventListener("submit", e => {
            e.preventDefault();
            const date = e.target.elements["date"].value;
            loadTable(date || null);
        });
    </script>
</body>
</html>
